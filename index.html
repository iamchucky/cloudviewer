<!doctype html>
<head>
	<title>CloudViewer</title>
	<link rel="stylesheet" href="static/css/bootstrap.min.css">
	<link rel="stylesheet" href="static/css/font-awesome.min.css">
	<link rel="stylesheet" href="static/css/cloudviewer.css">

	<script src="static/js/jquery-1.8.2.min.js"></script>
  <script src="static/js/dat.gui.min.js"></script>
  <script src="static/js/stats.min.js"></script>
  <script src="static/js/lightgl.js"></script>

  <script src="static/js/utils.js"></script>
  <script src="static/js/trackball.js"></script>
  <script src="static/js/glsl.js"></script>
  <script src="static/js/cloudviewer.js"></script>
  <script src="static/js/plyloader.js"></script>
  <script src="static/js/main.js"></script>
</head>

<body oncontextmenu="return false;">

  <script id="parse_plybody" type="javascript/worker">

    self.addEventListener('message', function(e) {
      var data = e.data;
      var v = data.vertex;
      var posArray = new Float32Array(v.count * 3);
      var colorArray = new Float32Array(v.count * 3);
      var idxArray = new Float32Array(v.count);

      var vcount = v.count;
      var vprops = v.properties;
      var vpropsLength = vprops.length;

      for (var i = 0; i < vcount*3; ++i) {
        colorArray[i] = 1.0;
      }

      var step = vcount / 50; 
      var nextStep = step;

      for (var j = 0; j < vcount; ++j) {
        var split = data.body[j].split(' ');
        
        for (var i = 0; i < vpropsLength; ++i) {
          var prop = vprops[i].name;
          if (prop != 'x' && prop != 'y' && prop != 'z' &&
              prop != 'red' && prop != 'green' && prop != 'blue' &&
              prop != 'diffuse_red' && prop != 'diffuse_green' && prop != 'diffuse_blue') {
            continue;
          }

          var val = parseFloat(split[i]);
          if (prop == 'x') {
            posArray[j * 3] = val;
          } else if (prop == 'y') {
            posArray[j * 3 + 1] = val;
          } else if (prop == 'z') {
            posArray[j * 3 + 2] = val;
          } else if (prop == 'red' || prop == 'diffuse_red') {
            colorArray[j * 3] = val / (vprops[i].type == 'uchar' ? 256.0 : 1.0);
          } else if (prop == 'green' || prop == 'diffuse_green') {
            colorArray[j * 3 + 1] = val / (vprops[i].type == 'uchar' ? 256.0 : 1.0);
          } else if (prop == 'blue' || prop == 'diffuse_blue') {
            colorArray[j * 3 + 2] = val / (vprops[i].type == 'uchar' ? 256.0 : 1.0);
          }
        }
        idxArray[j] = j;

        var progress = j / vcount;
        if (j > nextStep) {
          self.postMessage({status: 'update', update: progress});
          nextStep += step;
        }
      }

      self.postMessage({status: 'done', pos: posArray, color: colorArray, idx: idxArray});
      colorArray = null;
      idxArray = null;
    }, false);

  </script>

  <div id='dropzone'><span>Drop files here</span></div>
  <canvas id="canvas"></canvas>
  <div id="top_container">
    <div id="loading_text"><i class="fa fa-spinner fa-spin"></i> Loading...</div>
  </div>
  <div id="dataset" style="display:none">{{dataset}}</div>
  <div id="bottom_container">
    <div id="shortkey_help">
      <ul>
        <li><div style="width:100%;"><div style="width:80px;">pan:</div><div style="margin-left:10px">middle mouse-drag or ctrl+left mouse-drag</div></div></li>
        <li><div style="width:100%;"><div style="width:80px;">zoom:</div><div style="margin-left:10px">alt+left mouse-drag or scroll</div></div></li>
        <li><div style="width:100%;"><div style="width:80px;">select:</div><div style="margin-left:10px">left double mouse-click</div></div></li>
        <li><div style="width:100%;"><div style="width:80px;">reset trackball:</div><div style="margin-left:10px">right mouse-click</div></div></li>
        <li><div style="width:100%;"><div style="width:80px;">point size:</div><div style="margin-left:10px">alt+scroll</div></div></li>
      </ul>
    </div>
  </div>
  <progress id="loader_progress" value="1" max="100"></progress>

</body>
